import{r as l,w as V,i as te,n as G,s as oe,c as d,a as o,t as I,F as k,b as P,e as C,x as ne,l as se,v as ae,m as ie,y as de,o as i,d as le,f as R,u as re}from"./index-DXBiOaP8.js";import{g as X,a as q,b as z,c as ce,d as K,e as ue}from"./group_chat-t0rLMliE.js";import{_ as ve,u as me,s as fe}from"./_plugin-vue_export-helper-D_52YD_W.js";import{t as pe}from"./utilFn-1iToDg8-.js";import{u as he}from"./chat-C1OJTjRb.js";import{N as Ie}from"./NoData-Cz5gNT8B.js";const ye={class:"chat-tontainer"},ge={class:"chat-tontainer-top"},_e={key:0,class:"left-chat-info"},ke=["src"],Ce={class:"chat-info-common"},xe=["title"],Re={key:1,class:"right-chat-info"},we={class:"chat-info-common right-chat-info-div"},Le=["title"],Me=["src"],Ee={class:"icons-containers"},je={class:"icon","aria-hidden":"true"},Ue=["xlink:href"],be={class:"group-user-tontainer"},De={class:"search"},Be=["onContextmenu"],Ae=["src"],Te={class:"group-user-info-tontainer-right"},Ge=["title"],Pe=["onClick"],Fe=["onClick"],Ne=["onClick"],Se=["onClick"],He={__name:"ChatGroopRoomView",setup(Ye){const x=de(),W=re(),c=me(),m=he(),h=l(),E=l(),F=l(),u=l(),y=l(1),N=l();let S,H;const J=[{class:"#icon-biaoqing",id:1,title:"表情包"},{class:"#icon-stationary_file",id:2,title:"发送文件"},{class:"#icon-shipin",id:3,title:"视频通话"},{class:"#icon-gengduox",id:4,title:"更多"}],j=l(!1),w=l({}),f=l([]),L=l([]),v=l(),Y=l(""),g=l(),U=l("");V(U,(n,t)=>{n.length===0?L.value=f.value:L.value=f.value.filter(e=>e.username.indexOf(n)!==-1)}),V(()=>x.params.roomId,async(n,t)=>{m.resetChatList(),m.updateActiveRoomId(n);const e={roomId:n},{data:s}=await X(e);w.value=s.data;const{data:a}=await q(e);f.value=a.data;const r={roomId:n,joinId:c.user.info.id},{data:p}=await z(r);g.value=p.data.identity,y.value=1;const _={roomId:n,page:y.value},T=await D(_);m.addAfterChat(T)});function b(){if(j.value)return;const n=E.value.innerText.trim();if(n.length===0){alert("发送内容不能为空");return}const t=x.params.roomId,e=c.user.info.id,s=new Date;m.updateRoomList({roomId:t,conment:n,createdAt:s});const a=parseInt(x.query.receiveId),r=1,p=c.user.info.username,_=c.user.info.avatar,T={roomId:t,sendId:e,conment:n,receiveId:a,type:r,sendIdUsername:p,sendIdAvatar:_};m.addAfterChat({conment:n,roomId:t,sendId:e,receiveId:a,type:r,sendIdUsername:p,sendIdAvatar:_}),fe.emit("send_group_chat",T),G(()=>{E.value.innerText="",h.value.scrollTop=h.value.scrollHeight})}async function D(n){const{data:t}=await ce(n),{data:e}=t;return N.value=t.totalPage,y.value<N.value&&y.value++,e}async function Q(n){var t;if(((t=n.target)==null?void 0:t.scrollTop)<10){const s={roomId:x.params.roomId,page:y.value},a=await D(s);m.addBeforeChat(a)}}const Z=pe(Q,500);function $(n){var t,e;n.preventDefault(),n.stopPropagation(),S=n.clientX-((t=u.value)==null?void 0:t.getBoundingClientRect().left),H=n.clientY-((e=u.value)==null?void 0:e.getBoundingClientRect().top),document.addEventListener("mousemove",B),document.addEventListener("mouseup",A)}function B(n){var a,r,p;j.value=!0;const t=(a=F.value)==null?void 0:a.getBoundingClientRect();let e=n.clientX-S-t.left,s=n.clientY-H-t.top;e=Math.max(0,Math.min(e,t.width-((r=u.value)==null?void 0:r.offsetWidth))),s=Math.max(0,Math.min(s,t.height-((p=u.value)==null?void 0:p.offsetHeight))),G(()=>{u.value&&(u.value.style.left=`${e}px`,u.value.style.top=`${s}px`)})}function A(){setTimeout(()=>{j.value=!1},100),document.removeEventListener("mousemove",B),document.removeEventListener("mouseup",A)}function ee(n,t){Y.value=t,n.preventDefault(),console.log(v.value),v.value&&v.value[0]&&(v.value[0].style.display="block",v.value[0].style.left="0px",v.value[0].style.top=`${n.pageY}px`)}async function M(n,t){n.stopPropagation();const e={roomId:t.roomId,joinId:t.joinId};if(t.methodId===1){e.identity=2,O();const{data:s}=await K(e);s.code!==200&&alert(s.message),f.value.forEach(a=>{a.joinId===t.joinId&&(a.identity=2)});return}if(t.methodId===2){e.identity=3;const{data:s}=await K(e);s.code!==200&&alert(s.message),f.value.forEach(a=>{a.joinId===t.joinId&&(a.identity=3)});return}if(t.methodId===3){let s;const{data:a}=await ue(e);a.code!==200&&alert(a.message),s=f.value.indexOf(r=>r.joinId===t.joinId),f.value.splice(s,1);return}t.methodId===4&&W.push(`/user?id=${t.joinId}`)}function O(n){v.value&&v.value[0]&&(v.value[0].style.display="none")}return te(async()=>{const n=x.params.roomId;m.updateActiveRoomId(n);const t={roomId:n},{data:e}=await X(t);w.value=e.data;const{data:s}=await q(t);f.value=s.data,L.value=s.data;const a={roomId:n,joinId:c.user.info.id},{data:r}=await z(a);g.value=r.data.identity;const p={roomId:n,page:y.value},_=await D(p);m.addAfterChat(_),document.addEventListener("click",O),G(()=>{h.value&&(h.value.addEventListener("scroll",Z),u.value.addEventListener("mousedown",$),h.value.scrollTop=h.value.scrollHeight)})}),oe(()=>{var n,t;(n=h.value)==null||n.removeEventListener("scroll",b),(t=u.value)==null||t.removeEventListener("mousedown",$),document.removeEventListener("mousemove",B),document.removeEventListener("mouseup",A)}),(n,t)=>(i(),d(k,null,[o("div",ye,[o("div",ge,[o("span",null,"群聊名称:"+I(w.value.roomName),1),o("span",null,"群号:"+I(w.value.roomId),1)]),o("div",{class:"chat-message",ref_key:"chatMessageRef",ref:h},[(i(!0),d(k,null,P(C(m).chatList,e=>(i(),d(k,{key:e.roomId},[e.sendId!=C(c).user.info.id?(i(),d("div",_e,[o("div",null,[o("img",{src:e.sendIdAvatar,alt:"头像"},null,8,ke)]),o("div",Ce,[o("h3",null,I(e.sendIdUsername),1),o("p",{class:"conment",title:e.conment},I(e.conment),9,xe)])])):(i(),d("div",Re,[o("div",we,[o("h3",null,I(e.sendIdUsername),1),o("p",{class:"conment",title:e.conment},I(e.conment),9,Le)]),o("div",null,[o("img",{src:e.sendIdAvatar,alt:"头像"},null,8,Me)])]))],64))),128))],512),o("div",{class:"send-container",ref_key:"sendContainerRef",ref:F},[o("div",Ee,[(i(),d(k,null,P(J,e=>o("div",{class:"icons",key:e.id,title:"功能未开发"},[(i(),d("svg",je,[o("use",{"xlink:href":e.class},null,8,Ue)]))])),64))]),o("div",{class:"input-tontainer",contenteditable:"true",ref_key:"editableDivRef",ref:E,onKeydown:ne(b,["enter"])},null,544),o("div",{class:"send-btns .tuozhuai",ref_key:"sendBtnsRef",ref:u,onClick:b,title:"可在输入框内拖拽"},t[1]||(t[1]=[o("div",{class:"svg"},[o("svg",{class:"icon","aria-hidden":"true"},[o("use",{"xlink:href":"#icon-fasong"})])],-1),o("button",{type:"button"},"发送",-1)]),512)],512)]),o("div",be,[f.value.length>0?(i(),d(k,{key:0},[o("div",De,[se(o("input",{type:"text",name:"search",id:"search",placeholder:"输入昵称","onUpdate:modelValue":t[0]||(t[0]=e=>U.value=e)},null,512),[[ae,U.value]]),t[2]||(t[2]=o("div",{class:"icons"},[o("svg",{class:"icon","aria-hidden":"true"},[o("use",{"xlink:href":"#icon-sousuo"})])],-1))]),(i(!0),d(k,null,P(L.value,e=>(i(),d("div",{class:"group-user-info-tontainer",key:e.id,onContextmenu:s=>ee(s,e.joinId)},[o("img",{src:e.avatar,alt:"用户头像"},null,8,Ae),o("div",Te,[o("span",{class:"username",title:e.username},I(e.username),9,Ge),e.identity!==3?(i(),d("span",{key:0,class:le([{leader:e.identity===1,manager:e.identity===2},"auth"])},I(e.identity===1?"群主":"管理员"),3)):R("",!0)]),Y.value==e.joinId?(i(),d("div",{key:0,ref_for:!0,ref_key:"customMenuRef",ref:v,id:"customMenu"},[o("ul",null,[e.identity===3&&g.value===1?(i(),d("li",{key:0,onClick:s=>M(s,{id:C(c).user.info.id,...e,methodId:1})},t[3]||(t[3]=[o("span",null,"添加管理员",-1)]),8,Pe)):R("",!0),e.identity===2&&g.value===1?(i(),d("li",{key:1,onClick:s=>M(s,{id:C(c).user.info.id,...e,methodId:2})},t[4]||(t[4]=[o("span",null,"取消管理员",-1)]),8,Fe)):R("",!0),e.identity===3&&(g.value===1||g.value===2)?(i(),d("li",{key:2,onClick:s=>M(s,{id:C(c).user.info.id,...e,methodId:3})},t[5]||(t[5]=[o("span",null,"删除群员",-1)]),8,Ne)):R("",!0),o("li",{onClick:s=>M(s,{id:C(c).user.info.id,...e,methodId:4})},t[6]||(t[6]=[o("span",null,"查看资料",-1)]),8,Se)])],512)):R("",!0)],40,Be))),128))],64)):(i(),ie(Ie,{key:1,class:"no-data"}))])],64))}},Ke=ve(He,[["__scopeId","data-v-4c3b683f"]]);export{Ke as default};
