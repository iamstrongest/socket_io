import{r as c,w as z,i as se,n as B,s as ae,c as l,a as o,t as h,F as k,b as G,e as y,x as ie,l as de,v as re,m as le,y as ce,o as i,d as ue,f as R,u as me}from"./index-DVw92pm9.js";import{g as K,a as q,b as ve,c as O,d as fe}from"./group_chat-CzpvJGJe.js";import{_ as pe,u as he,s as W}from"./_plugin-vue_export-helper-DsrsFqtt.js";import{t as Ie}from"./utilFn-1iToDg8-.js";import{u as ye}from"./chat-BlAwU8ry.js";import{N as ge}from"./NoData-DaqeYu2V.js";const _e={class:"chat-tontainer"},ke={class:"chat-tontainer-top"},Ce={key:0,class:"left-chat-info"},Re=["src"],xe={class:"chat-info-common"},Le=["title"],we={key:1,class:"right-chat-info"},Ue={class:"chat-info-common right-chat-info-div"},Me=["title"],je=["src"],De={class:"icons-containers"},be={class:"icon","aria-hidden":"true"},Ae=["xlink:href"],Ee={class:"group-user-tontainer"},Be={class:"search"},Ge=["onContextmenu"],Pe=["src"],Te={class:"group-user-info-tontainer-right"},Fe=["title"],$e=["onClick"],Ne=["onClick"],Se=["onClick"],He=["onClick"],Ye={__name:"ChatGroopRoomView",setup(Ve){const x=ce(),J=me(),d=he(),a=ye(),p=c(),U=c(),P=c(),v=c(),g=c(1),T=c();let F,$;const Q=[{class:"#icon-biaoqing",id:1,title:"表情包"},{class:"#icon-stationary_file",id:2,title:"发送文件"},{class:"#icon-shipin",id:3,title:"视频通话"},{class:"#icon-gengduox",id:4,title:"更多"}],M=c(!1),L=c({}),C=c([]),f=c(),N=c(""),_=c(),j=c("");z(j,(n,t)=>{n.length===0?C.value=a.roomUserList.value:C.value=a.roomUserList.value.filter(e=>e.username.indexOf(n)!==-1)}),z(()=>x.params.roomId,async(n,t)=>{a.resetChatList(),a.updateActiveRoomId(n);const e={roomId:n},{data:s}=await K(e);L.value=s.data,C.value=a.roomUserList;const r={roomId:n,joinId:d.user.info.id},{data:u}=await q(r);_.value=u.data.identity,g.value=1;const m={roomId:n,page:g.value},I=await b(m);a.addAfterChat(I)});function D(){if(M.value)return;const n=U.value.innerText.trim();if(n.length===0){alert("发送内容不能为空");return}const t=x.params.roomId,e=d.user.info.id,s=new Date;a.updateRoomList({roomId:t,conment:n,createdAt:s});const r=1,u=d.user.info.username,m=d.user.info.avatar,I={roomId:t,sendId:e,conment:n,type:r,sendIdUsername:u,sendIdAvatar:m,isChat:!0};a.addAfterChat({conment:n,roomId:t,sendId:e,type:r,sendIdUsername:u,sendIdAvatar:m}),W.emit("send_group_chat",I),B(()=>{U.value.innerText="",p.value.scrollTop=p.value.scrollHeight})}async function b(n){const{data:t}=await ve(n),{data:e}=t;return T.value=t.totalPage,g.value<T.value&&g.value++,e}async function Z(n){var t;if(((t=n.target)==null?void 0:t.scrollTop)<10){const s={roomId:x.params.roomId,page:g.value},r=await b(s);a.addBeforeChat(r)}}const ee=Ie(Z,500);function S(n){var t,e;n.preventDefault(),n.stopPropagation(),F=n.clientX-((t=v.value)==null?void 0:t.getBoundingClientRect().left),$=n.clientY-((e=v.value)==null?void 0:e.getBoundingClientRect().top),document.addEventListener("mousemove",A),document.addEventListener("mouseup",E)}function A(n){var r,u,m;M.value=!0;const t=(r=P.value)==null?void 0:r.getBoundingClientRect();let e=n.clientX-F-t.left,s=n.clientY-$-t.top;e=Math.max(0,Math.min(e,t.width-((u=v.value)==null?void 0:u.offsetWidth))),s=Math.max(0,Math.min(s,t.height-((m=v.value)==null?void 0:m.offsetHeight))),B(()=>{v.value&&(v.value.style.left=`${e}px`,v.value.style.top=`${s}px`)})}function E(){setTimeout(()=>{M.value=!1},100),document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",E)}function te(n,t){N.value=t,n.preventDefault(),f.value&&f.value[0]&&(f.value[0].style.display="block",f.value[0].style.left="0px",f.value[0].style.top=`${n.pageY}px`)}async function w(n,t){console.log(t),n.stopPropagation();const e={roomId:t.roomId,joinId:t.joinId,handleId:d.user.info.id};if(t.methodId===1){e.identity=2,H();const{data:s}=await O(e);s.code!==200&&alert(s.message),a.updateGroupRoomUserIdenty({joinId:t.joinId,identity:2});return}if(t.methodId===2){e.identity=3;const{data:s}=await O(e);s.code!==200&&alert(s.message),a.updateGroupRoomUserIdenty({joinId:t.joinId,identity:3});return}if(t.methodId===3){const{data:s}=await fe(e);s.code!==200&&alert(s.message),a.deleteGroupRoomUserFn(t.joinId);const r=t.roomId,u=d.user.info.id,m=new Date,I=`${d.user.info.username}将${t.username}移除了群聊`;a.updateRoomList({roomId:r,conment:I,createdAt:m});const Y=1,V=d.user.info.username,X=d.user.info.avatar,oe=t.joinId,ne={roomId:r,sendId:u,conment:I,type:Y,sendIdUsername:V,sendIdAvatar:X,deleteId:oe,isChat:!1};a.addAfterChat({conment:I,roomId:r,sendId:u,type:Y,sendIdUsername:V,sendIdAvatar:X}),W.emit("send_group_chat",ne);return}t.methodId===4&&J.push(`/user?id=${t.joinId}`)}function H(n){f.value&&f.value[0]&&(f.value[0].style.display="none")}return se(async()=>{const n=x.params.roomId;a.updateActiveRoomId(n);const t={roomId:n},{data:e}=await K(t);L.value=e.data,await a.getGroupRoomUserFn(t),C.value=a.roomUserList;const s={roomId:n,joinId:d.user.info.id},{data:r}=await q(s);_.value=r.data.identity;const u={roomId:n,page:g.value},m=await b(u);a.addAfterChat(m),document.addEventListener("click",H),B(()=>{p.value&&(p.value.addEventListener("scroll",ee),v.value.addEventListener("mousedown",S),p.value.scrollTop=p.value.scrollHeight)})}),ae(()=>{var n,t;(n=p.value)==null||n.removeEventListener("scroll",D),(t=v.value)==null||t.removeEventListener("mousedown",S),document.removeEventListener("mousemove",A),document.removeEventListener("mouseup",E)}),(n,t)=>(i(),l(k,null,[o("div",_e,[o("div",ke,[o("span",null,"群聊名称:"+h(L.value.roomName),1),o("span",null,"群号:"+h(L.value.roomId),1)]),o("div",{class:"chat-message",ref_key:"chatMessageRef",ref:p},[(i(!0),l(k,null,G(y(a).chatList,e=>(i(),l(k,{key:e.roomId},[e.sendId!=y(d).user.info.id?(i(),l("div",Ce,[o("div",null,[o("img",{src:e.sendIdAvatar,alt:"头像"},null,8,Re)]),o("div",xe,[o("h3",null,h(e.sendIdUsername),1),o("p",{class:"conment",title:e.conment},h(e.conment),9,Le)])])):(i(),l("div",we,[o("div",Ue,[o("h3",null,h(e.sendIdUsername),1),o("p",{class:"conment",title:e.conment},h(e.conment),9,Me)]),o("div",null,[o("img",{src:e.sendIdAvatar,alt:"头像"},null,8,je)])]))],64))),128))],512),o("div",{class:"send-container",ref_key:"sendContainerRef",ref:P},[o("div",De,[(i(),l(k,null,G(Q,e=>o("div",{class:"icons",key:e.id,title:"功能未开发"},[(i(),l("svg",be,[o("use",{"xlink:href":e.class},null,8,Ae)]))])),64))]),o("div",{class:"input-tontainer",contenteditable:"true",ref_key:"editableDivRef",ref:U,onKeydown:ie(D,["enter"])},null,544),o("div",{class:"send-btns .tuozhuai",ref_key:"sendBtnsRef",ref:v,onClick:D,title:"可在输入框内拖拽"},t[1]||(t[1]=[o("div",{class:"svg"},[o("svg",{class:"icon","aria-hidden":"true"},[o("use",{"xlink:href":"#icon-fasong"})])],-1),o("button",{type:"button"},"发送",-1)]),512)],512)]),o("div",Ee,[y(a).roomUserList.length>0?(i(),l(k,{key:0},[o("div",Be,[de(o("input",{type:"text",name:"search",id:"search",placeholder:"输入昵称","onUpdate:modelValue":t[0]||(t[0]=e=>j.value=e)},null,512),[[re,j.value]]),t[2]||(t[2]=o("div",{class:"icons"},[o("svg",{class:"icon","aria-hidden":"true"},[o("use",{"xlink:href":"#icon-sousuo"})])],-1))]),(i(!0),l(k,null,G(C.value,e=>(i(),l("div",{class:"group-user-info-tontainer",key:e.joinId,onContextmenu:s=>te(s,e.joinId)},[o("img",{src:e.avatar,alt:"用户头像"},null,8,Pe),o("div",Te,[o("span",{class:"username",title:e.username},h(e.username),9,Fe),e.identity!==3?(i(),l("span",{key:0,class:ue([{leader:e.identity===1,manager:e.identity===2},"auth"])},h(e.identity===1?"群主":"管理员"),3)):R("",!0)]),N.value==e.joinId?(i(),l("div",{key:0,ref_for:!0,ref_key:"customMenuRef",ref:f,id:"customMenu"},[o("ul",null,[e.identity===3&&_.value===1?(i(),l("li",{key:0,onClick:s=>w(s,{id:y(d).user.info.id,...e,methodId:1})},t[3]||(t[3]=[o("span",null,"添加管理员",-1)]),8,$e)):R("",!0),e.identity===2&&_.value===1?(i(),l("li",{key:1,onClick:s=>w(s,{id:y(d).user.info.id,...e,methodId:2})},t[4]||(t[4]=[o("span",null,"取消管理员",-1)]),8,Ne)):R("",!0),e.identity===3&&(_.value===1||_.value===2)?(i(),l("li",{key:2,onClick:s=>w(s,{id:y(d).user.info.id,...e,methodId:3})},t[5]||(t[5]=[o("span",null,"删除群员",-1)]),8,Se)):R("",!0),o("li",{onClick:s=>w(s,{id:y(d).user.info.id,...e,methodId:4})},t[6]||(t[6]=[o("span",null,"查看资料",-1)]),8,He)])],512)):R("",!0)],40,Ge))),128))],64)):(i(),le(ge,{key:1,class:"no-data"}))])],64))}},Je=pe(Ye,[["__scopeId","data-v-2c05943b"]]);export{Je as default};
